<div class="overall-div">

<h1> New Trade</h1>

<% if @trade.errors.any? %>
    <div>
        <h3><%= pluralize(@trade.errors.count, "error") %> prevented saving:</h3>
        <ul>
            <% @trade.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
            <% end %>
        </ul>
    </div>
<% end %>



<%= form_with model: @trade do |f|%>
    <div class="new-trade-text" >
        <%= f.label :stock_id, "Ticker" %>
        <%= f.select :stock_id,
            options_from_collection_for_select(@stocks, :id, :symbol, @trade.stock_id),
            { prompt: "Select a ticker" },
            { id: "trade_stock_id" } %>
    </div>

    <div class="new-trade-text" >
        <%= f.label :side %>
        <%= f.select :side, Trade.sides.keys.map { |k| [k.titleize, k] }%>
    </div>

    <div class="new-trade-text" >
        <%= f.label :quantity  %>
        <%= f.number_field :quantity, step:0.0001, id: "trade_quantity" %>
    </div>

    <div class="new-trade-text" >
        <%= f.label :price  %>
        <%= f.number_field :price, step: 0.0001, id: "trade_price" %>
    </div>
    <div class="new-trade-text" >
        <%= f.label :trade_date  %>
        <%= f.date_field :trade_date, id: "trade_trade_date" %>
    </div>
    <div class="new-trade-text">
    <p>Total: <span id="trade_total">$0.00</span></p>
    </div>
    <div class="new-trade-text">
    <p>Cash: <strong><%= number_to_currency(@cash_balance) %></strong></p>
    </div>
        <div style="margin-top: 12px;">
        <%= f.submit "Create Trade", class:"btn" %>
    </div>
<% end %>

<div id="price-history-wrapper" class="table-wrap-new-trade" hidden>
<%# <div id="price-history-wrapper" class="table-wrap" hidden> %>
  <div class="table-title">
    <h2>Price history</h2>
  </div>
  <div>
    <%= line_chart [], id: "price-history-chart",
      library: {
        animation: false,
        elements: {
          point: { radius: 0 }
        }
      } %>
  </div>
</div>





<div class="button-wrapper">
<p class="back-to-portfolio"><%= link_to "Back to Portfolio", trades_path, class:"btn" %></p>
</div>

</div>





<script>
  document.addEventListener("turbo:load", () => {
    const stockSelect = document.getElementById("trade_stock_id");
    const dateField   = document.getElementById("trade_trade_date");
    const priceEl     = document.getElementById("trade_price");
    const qtyEl       = document.getElementById("trade_quantity");
    const totalEl     = document.getElementById("trade_total");
    const chartWrapper = document.getElementById("price-history-wrapper");
    const chartId = "price-history-chart";

    if (!stockSelect || !dateField || !priceEl || !qtyEl || !totalEl) return;

    function updateTotal() {
      const price = parseFloat(priceEl.value || "0");
      const qty   = parseFloat(qtyEl.value || "0");
      const total = price * qty;

      totalEl.textContent = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD"
      }).format(total);
    }

    async function fillPriceIfBlank() {
      const stockId = stockSelect.value;
      const date    = dateField.value;
      if (!stockId || !date) return;

      if (priceEl.value && priceEl.value.trim() !== "") return;

      const resp = await fetch(`/stocks/${stockId}/close_price?date=${encodeURIComponent(date)}`);
      if (!resp.ok) return;

      const data = await resp.json();
      if (data.close != null) {
        priceEl.value = data.close;
        updateTotal();
      }
    }

    function setChartVisibility(show) {
      if (chartWrapper) {
        chartWrapper.hidden = !show;
      }
    }

    function updateChartData(data, attempt = 0) {
      const chart = window.Chartkick?.charts?.[chartId];
      if (!chart) {
        if (attempt >= 20) return;
        return setTimeout(() => updateChartData(data, attempt + 1), 50);
      }
      chart.updateData(data);
    }

    async function refreshPriceHistory(stockId) {
      if (!chartWrapper) return;
      if (!stockId) {
        setChartVisibility(false);
        return;
      }

      setChartVisibility(true);
      const resp = await fetch(`/stocks/${stockId}/price_history`);
      if (!resp.ok) {
        setChartVisibility(false);
        return;
      }

      const data = await resp.json();
      updateChartData(data);
    }

    // price autofill triggers
    stockSelect.addEventListener("change", () => {
      fillPriceIfBlank();
      refreshPriceHistory(stockSelect.value);
    });
    dateField.addEventListener("change", fillPriceIfBlank);

    // total cost / proceeds triggers
    priceEl.addEventListener("input", updateTotal);
    qtyEl.addEventListener("input", updateTotal);

    //initialize
    fillPriceIfBlank();
    updateTotal();
    refreshPriceHistory(stockSelect.value);
  });
</script>
